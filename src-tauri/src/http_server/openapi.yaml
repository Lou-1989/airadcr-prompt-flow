openapi: 3.0.3
info:
  title: AIRADCR Desktop Local API
  description: |
    API HTTP locale exposée par l'application AIRADCR Desktop sur le port 8741.
    Permet aux systèmes RIS/PACS externes d'envoyer des rapports radiologiques
    pré-remplis de manière sécurisée et confidentielle (stockage local uniquement).
    
    ## Sécurité Patient-Safe
    Toutes les données nominatives sont **INTERDITES** et seront rejetées automatiquement.
    Les champs suivants déclenchent une erreur 400 :
    - patient_id, patient_name, birth_date, ssn, address, phone, email, etc.
    
    ## Authentification
    L'endpoint POST nécessite une clé API via l'en-tête `X-API-Key`.
    Les endpoints GET et DELETE sont accessibles localement sans authentification.
  version: 1.0.0
  contact:
    name: AIRADCR Support
    email: contact@airadcr.com
    url: https://airadcr.com

servers:
  - url: http://localhost:8741
    description: Serveur HTTP local (Tauri Desktop)

paths:
  /health:
    get:
      summary: Vérification de l'état du serveur
      description: Retourne le statut du serveur HTTP local
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Serveur opérationnel
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "ok"
                timestamp: "2025-12-15T23:15:00Z"
                version: "1.0.0"

  /pending-report:
    post:
      summary: Stocke un rapport radiologique en attente
      description: |
        Enregistre un rapport pré-rempli depuis un système RIS/PACS externe.
        Le rapport sera récupérable via l'URL `https://airadcr.com/app?tid=XXX`.
        
        **Validation Patient-Safe** : Toute donnée nominative sera rejetée.
      operationId: storePendingReport
      tags:
        - Pending Reports
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StorePendingReportRequest'
            example:
              technical_id: "TEO_2024_001"
              structured:
                title: "IRM Cérébrale"
                indication: "Céphalées chroniques"
                technique: "Séquences T1, T2, FLAIR, diffusion"
                results: "Résultats de l'analyse IA CAD..."
                conclusion: ""
              source_type: "teohub"
              ai_modules: ["nodule_detection", "brain_volumetry"]
              expires_in_hours: 24
      responses:
        '200':
          description: Rapport stocké avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreSuccessResponse'
        '400':
          description: Violation Patient-Safe ou données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Patient-Safe violation: nominative data detected"
                field: "patient_id"
        '401':
          description: Clé API invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid API key"

    get:
      summary: Récupère un rapport en attente
      description: |
        Retourne les données d'un rapport stocké localement.
        Marque automatiquement le rapport comme "récupéré".
      operationId: getPendingReport
      tags:
        - Pending Reports
      parameters:
        - name: tid
          in: query
          required: true
          description: Identifiant technique du rapport
          schema:
            type: string
          example: "TEO_2024_001"
      responses:
        '200':
          description: Rapport trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetReportResponse'
        '404':
          description: Rapport non trouvé ou expiré
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetReportResponse'
              example:
                success: false
                error: "Report not found or expired"

    delete:
      summary: Supprime un rapport en attente
      description: Supprime définitivement un rapport de la base locale
      operationId: deletePendingReport
      tags:
        - Pending Reports
      parameters:
        - name: tid
          in: query
          required: true
          description: Identifiant technique du rapport
          schema:
            type: string
          example: "TEO_2024_001"
      responses:
        '200':
          description: Rapport supprimé
          content:
            application/json:
              schema:
              $ref: '#/components/schemas/DeleteResponse'

  /find-report:
    get:
      summary: Recherche un rapport par identifiants RIS
      description: |
        Permet au RIS de trouver un rapport en utilisant ses propres identifiants
        (accession_number, patient_id, exam_uid) sans connaître le technical_id
        généré par TÉO Hub.
        
        **Cas d'usage** : Le RIS possède l'accession_number mais pas le technical_id.
      operationId: findReport
      tags:
        - RIS Integration
      parameters:
        - name: accession_number
          in: query
          required: false
          description: Numéro d'accession DICOM
          schema:
            type: string
          example: "ACC2024001"
        - name: patient_id
          in: query
          required: false
          description: ID patient local/RIS
          schema:
            type: string
          example: "PAT123456"
        - name: exam_uid
          in: query
          required: false
          description: UID DICOM de l'examen
          schema:
            type: string
          example: "1.2.840.113619.2.XXX.YYY.ZZZ"
      responses:
        '200':
          description: Rapport trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FindReportResponse'
              example:
                success: true
                data:
                  technical_id: "TEO_2024_12345"
                  patient_id: "PAT123456"
                  accession_number: "ACC2024001"
                  exam_uid: "1.2.840.113619.2.XXX.YYY.ZZZ"
                  structured:
                    title: "IRM Cérébrale"
                    indication: "Céphalées chroniques"
                    technique: "IRM 3T avec injection"
                    results: "Analyse IA TÉO Hub..."
                    conclusion: ""
                  source_type: "teo_hub"
                  ai_modules: ["brain_volumetry", "lesion_detection"]
                  modality: "MR"
                  status: "pending"
                  created_at: "2024-12-16T10:30:00Z"
                retrieval_url: "http://localhost:8741/pending-report?tid=TEO_2024_12345"
        '400':
          description: Aucun identifiant fourni
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "At least one identifier required: accession_number, patient_id, or exam_uid"
        '404':
          description: Rapport non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "No report found matching the provided identifiers"

  /open-report:
    post:
      summary: Ouvre AIRADCR sur un rapport spécifique
      description: |
        Déclenche la navigation automatique de l'iframe AIRADCR vers un rapport.
        La fenêtre AIRADCR passe au premier plan automatiquement.
        
        **Comportement** :
        1. Si `tid` fourni → utilisation directe
        2. Sinon → recherche dans la base par identifiants RIS
        3. Émission d'un événement Tauri `airadcr:navigate_to_report`
        4. L'iframe navigue vers `https://airadcr.com/app?tid=XXX`
        5. La fenêtre passe au premier plan
      operationId: openReport
      tags:
        - RIS Integration
      parameters:
        - name: tid
          in: query
          required: false
          description: Technical ID direct (prioritaire)
          schema:
            type: string
          example: "TEO_2024_12345"
        - name: accession_number
          in: query
          required: false
          description: Numéro d'accession DICOM
          schema:
            type: string
          example: "ACC2024001"
        - name: patient_id
          in: query
          required: false
          description: ID patient local/RIS
          schema:
            type: string
          example: "PAT123456"
        - name: exam_uid
          in: query
          required: false
          description: UID DICOM de l'examen
          schema:
            type: string
          example: "1.2.840.113619.2.XXX.YYY.ZZZ"
      responses:
        '200':
          description: Navigation déclenchée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenReportResponse'
              example:
                success: true
                message: "Navigation triggered successfully"
                technical_id: "TEO_2024_12345"
                navigated_to: "https://airadcr.com/app?tid=TEO_2024_12345"
        '400':
          description: Aucun identifiant fourni
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "At least one identifier required: tid, accession_number, patient_id, or exam_uid"
        '404':
          description: Rapport non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "No report found matching the provided identifiers"
        '500':
          description: Erreur de navigation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Failed to trigger navigation event"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Clé API pour l'authentification des systèmes RIS/PACS

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok]
        timestamp:
          type: string
          format: date-time
        version:
          type: string

    StorePendingReportRequest:
      type: object
      required:
        - technical_id
        - structured
      properties:
        technical_id:
          type: string
          description: Identifiant technique unique du rapport
          example: "TEO_2024_001"
        structured:
          type: object
          description: Données structurées du rapport (sans données nominatives!)
          properties:
            title:
              type: string
              example: "IRM Cérébrale"
            indication:
              type: string
              example: "Céphalées chroniques"
            technique:
              type: string
              example: "Séquences T1, T2, FLAIR, diffusion"
            results:
              type: string
              example: "Résultats de l'analyse IA..."
            conclusion:
              type: string
              example: ""
        source_type:
          type: string
          default: "tauri_local"
          example: "teohub"
        ai_modules:
          type: array
          items:
            type: string
          example: ["nodule_detection", "brain_volumetry"]
        expires_in_hours:
          type: integer
          default: 24
          minimum: 1
          maximum: 168
          example: 24

    StoreSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        technical_id:
          type: string
          example: "TEO_2024_001"
        retrieval_url:
          type: string
          format: uri
          example: "https://airadcr.com/app?tid=TEO_2024_001"
        expires_at:
          type: string
          format: date-time
          example: "2025-12-16T23:15:00Z"

    GetReportResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          nullable: true
          properties:
            structured:
              type: object
            source_type:
              type: string
            ai_modules:
              type: array
              items:
                type: string
            created_at:
              type: string
              format: date-time
        error:
          type: string
          nullable: true

    DeleteResponse:
      type: object
      properties:
        success:
          type: boolean
        deleted:
          type: boolean

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        field:
          type: string
          nullable: true

    FindReportResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          nullable: true
          properties:
            technical_id:
              type: string
            patient_id:
              type: string
            accession_number:
              type: string
            exam_uid:
              type: string
            study_instance_uid:
              type: string
            structured:
              type: object
              properties:
                title:
                  type: string
                indication:
                  type: string
                technique:
                  type: string
                results:
                  type: string
                conclusion:
                  type: string
            source_type:
              type: string
            ai_modules:
              type: array
              items:
                type: string
            modality:
              type: string
            metadata:
              type: object
            status:
              type: string
              enum: [pending, retrieved]
            created_at:
              type: string
              format: date-time
        retrieval_url:
          type: string
          format: uri

    OpenReportResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        technical_id:
          type: string
        navigated_to:
          type: string
          format: uri

tags:
  - name: Health
    description: Vérification de l'état du serveur
  - name: Pending Reports
    description: Gestion des rapports radiologiques en attente
  - name: RIS Integration
    description: Endpoints pour l'intégration avec les systèmes RIS/PACS
